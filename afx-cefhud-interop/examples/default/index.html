<!DOCTYPE html>
<!--

## Usage:

Launch CS:GO from HLAE with -afxInteropLight.

For testing execute (will log to debug.log in current directoy):
afx-cefhud-interop.exe "--url=file:///C:/source/afx-cefhud-interop/afx-cefhud-interop/examples/default/index.html" --enable-logging --v=1

For live execute:
afx-cefhud-interop.exe "--url=file:///C:/source/afx-cefhud-interop/afx-cefhud-interop/examples/default/index.html" --enable-logging --log-severity=error

Enter afx_interop connect 1 into CS:GO console.

Console inteface:
afx_interop send cefhud [...]

-->
<html>
<head>
<title>Default example</title>
</head>
<body>
<h1>Default example</h1>
<script>

function AfxInterop(interop, args) {
	
	var self = this;
	
	this.interop = interop;
	this.args = args;
	this.taskQueue = [];
	
	this.messageHandlers = {
	};
	
	interop.onMessage = function(senderId, message){
		self.onMessage(senderId, message);
	};
	interop.onError = function(senderId, message){
		self.onError(senderId, message);
	};
	
	this.drawingInteropId = null;
	this.engineInteropId = null;
	
	var fileFolderPath = window.location.toString();
	fileFolderPath = fileFolderPath.replace("/index.html","");
	
	interop.createDrawingInterop(
		fileFolderPath+"/drawing.html",
		JSON.stringify({
			"indexInteropId": this.interop.id,
			"pipeName": "advancedfxInterop_drawing"
		}),
		function(drawingInteropId){
			console.log("Created drawing interop #"+drawingInteropId);
			self.drawingInteropId = drawingInteropId;
			
			self.interop.createEngineInterop(
				fileFolderPath+"/engine.html",
				JSON.stringify({
					"indexInteropId": self.interop.id,
					"drawingInteropId": self.drawingInteropId,
					"pipeName": "advancedfxInterop"
				}),
				function(engineInteropId){
					console.log("Created engine interop #"+engineInteropId);
					self.engineInteropId = drawingInteropId;
				},
				function(errorMessage){
					throw "Creating engine interop failed: "+errorMessage;
				}
			);
		},
		function(errorMessage){
			throw "Creating drawing interop failed: "+errorMessage;
		}
	);
}

AfxInterop.prototype.onMessage = function(senderId, message) {
	const args = JSON.parse(message);
	this.messageHandlers[args.id].apply(this, args.args);
	console.log("AfxInterop.prototype.onMessage error: "+error);
}

AfxInterop.prototype.onError = function(senderId, message) {
	
	if(this.drawingInteropId === senderId)
		throw ("Drawing interop #"+senderId+" error: "+message);
	else if(this.engineInteropId === senderId)
		throw ("Engine interop #"+senderId+" error: "+message);
	else
		throw ("Interop #"+senderId+" error: "+message);
}

////////////////////////////////////////////////////////////////////////////////

AfxInterop.prototype.queueTask = function(task) {
	
	var self = this;
	
	this.taskQueue.push(task);
	
	if(this.taskQueue.length === 1) {
		queueMicrotask(function(){
			for(var i = 0; i < self.taskQueue.length; ++i)
			{
				self.taskQueue[i].call(self);
			}
			self.taskQueue = [];
		});
	}
}

////////////////////////////////////////////////////////////////////////////////

window.afxInterop.init(function(interop, message){
	console.log(message);
	new AfxInterop(interop, JSON.parse(message));
});

</script>
</body>
</html>